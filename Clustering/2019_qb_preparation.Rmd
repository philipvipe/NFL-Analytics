---
title: "K-Means Clustering of 2019 NFL Quarterbacks, Running Backs and Receivers"
author: "Philip Ipe"
date: "4/3/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(lubridate)
library(tidyverse)
library(knitr)
```

## Data Scraping and Preparation

Scraping Advanced Passing Data from 2019 from Pro-Football Reference
```{r scraping_passing}
player_adv_stats_url <- "https://www.pro-football-reference.com/years/2019/passing_advanced.htm"
player_std_stats_url <- "https://www.pro-football-reference.com/years/2019/passing.htm"

adv_stats_html <- read_html(player_adv_stats_url)
std_stats_html <- read_html(player_std_stats_url)
```
Scrape and prepare standard passing data
```{r scrape_ay}
std_pass_df <- std_stats_html %>%
  html_node("#div_passing") %>%
  html_node("table") %>%
  html_table()

names(std_pass_df)[26] <- "Yds_sacks"

# Keep only the top 29 QBs
std_pass_df$Rk <- as.numeric(as.character(std_pass_df$Rk))
std_pass_df <- std_pass_df %>%
  filter(Rk <= 29)

# Convert all columns to numeric
std_pass_df$Age <- as.numeric(as.character(std_pass_df$Age))
std_pass_df$G <- as.numeric(as.character(std_pass_df$G))
std_pass_df$GS <- as.numeric(as.character(std_pass_df$GS))
std_pass_df$Cmp <- as.numeric(as.character(std_pass_df$Cmp))
std_pass_df$Att <- as.numeric(as.character(std_pass_df$Att))
std_pass_df$'Cmp%' <- as.numeric(sub('%', '', as.character(std_pass_df$'Cmp%')))/100
std_pass_df$Yds <- as.numeric(as.character(std_pass_df$Yds))
std_pass_df$TD <- as.numeric(as.character(std_pass_df$TD))
std_pass_df$'TD%' <- as.numeric(sub('%', '', as.character(std_pass_df$'TD%')))/100
std_pass_df$Int <- as.numeric(as.character(std_pass_df$Int))
std_pass_df$'Int%' <- as.numeric(sub('%', '', as.character(std_pass_df$'Int%')))/100
std_pass_df$'1D' <- as.numeric(as.character(std_pass_df$'1D'))
std_pass_df$Lng <- as.numeric(as.character(std_pass_df$Lng))
std_pass_df$'Y/A' <- as.numeric(as.character(std_pass_df$'Y/A'))
std_pass_df$'AY/A' <- as.numeric(as.character(std_pass_df$'AY/A'))
std_pass_df$'Y/C' <- as.numeric(as.character(std_pass_df$'Y/C'))
std_pass_df$'Y/G' <- as.numeric(as.character(std_pass_df$'Y/G'))
std_pass_df$Rate <- as.numeric(as.character(std_pass_df$Rate))
std_pass_df$QBR <- NULL
std_pass_df$Sk <- as.numeric(as.character(std_pass_df$Sk))
std_pass_df$Yds_sacks <- as.numeric(as.character(std_pass_df$Yds_sacks))
std_pass_df$'NY/A' <- as.numeric(as.character(std_pass_df$'NY/A'))
std_pass_df$'ANY/A' <- as.numeric(as.character(std_pass_df$'ANY/A'))
std_pass_df$'Sk%' <- as.numeric(sub('%', '', as.character(std_pass_df$'Sk%')))/100
std_pass_df$'4QC' <- as.numeric(as.character(std_pass_df$'4QC'))
std_pass_df$GWD <- as.numeric(as.character(std_pass_df$GWD))

std_pass_df[is.na(std_pass_df)] <- 0
```

Make all variables standardized per game played and remove the old non-standardized variables
```{r standardize}
std_pass_df <- std_pass_df %>%
  mutate('Cmp/G' = Cmp/G) %>%
  mutate('Att/G' = Att/G) %>%
  mutate('Yds/G' = Yds/G) %>%
  mutate('TD/G' = TD/G) %>%
  mutate('Int/G' = Int/G) %>%
  mutate('1D/G' = std_pass_df$'1D'/G) %>%
  mutate('Sk/G' = Sk/G) %>%
  mutate('Yds_sacks/G' = Yds_sacks/G) %>%
  mutate('4QC/G' = std_pass_df$'4QC'/G) %>%
  mutate('GWD/G' = GWD/G)

std_pass_df$Cmp <- NULL
std_pass_df$Att <- NULL
std_pass_df$Yds <- NULL
std_pass_df$TD <- NULL
std_pass_df$Int <- NULL
std_pass_df$'1D' <- NULL
std_pass_df$Sk <- NULL
std_pass_df$Yds_sacks <- NULL
std_pass_df$'4QC' <- NULL
std_pass_df$GWD <- NULL
std_pass_df$Lng <- NULL
```

Scrape the advanced passing air yards dataframe data
```{r scrape_ay}
adv_pass_ay_df <- adv_stats_html %>%
  html_node("#all_ks_passing_detailed_air_yards") %>%
  html_node("table") %>%
  html_table()

names(adv_pass_ay_df) <- as.character(unlist(adv_pass_ay_df[1,]))
adv_pass_ay_df <- adv_pass_ay_df[-1,]
```

Similarly, scrape the advanced passing accuracy, passing under pressure, and passing based on play type statistics.
```{r scrape_acc_press}
# Accuracy Data
adv_pass_acc_df <- adv_stats_html %>%
  html_node("#all_ks_passing_detailed_accuracy") %>%
  html_node("table") %>%
  html_table()

names(adv_pass_acc_df) <- as.character(unlist(adv_pass_acc_df[1,]))
adv_pass_acc_df <- adv_pass_acc_df[-1,]

# Pressure Data
adv_pass_press_df <- adv_stats_html %>%
  html_node("#all_ks_passing_detailed_pressure") %>%
  html_node("table") %>%
  html_table()

names(adv_pass_press_df) <- as.character(unlist(adv_pass_press_df[1,]))
adv_pass_press_df <- adv_pass_press_df[-1,]

# Advanced Passing Play Type
adv_pass_play_type_df <- adv_stats_html %>%
  html_node("#all_ks_passing_detailed_play_type") %>%
  html_node("table") %>%
  html_table()

names(adv_pass_play_type_df) <- as.character(unlist(adv_pass_play_type_df[1,]))
adv_pass_play_type_df <- adv_pass_play_type_df[-1,]

# Gonna need to do some renaming of the columns to distinguish between RPO and Play Action (PA) plays
names(adv_pass_play_type_df)[11] <- "RPO_Plays"
names(adv_pass_play_type_df)[12] <- "RPO_Yds"
names(adv_pass_play_type_df)[13] <- "RPO_PassAtt"
names(adv_pass_play_type_df)[14] <- "RPO_PassYds"
names(adv_pass_play_type_df)[15] <- "RPO_RushAtt"
names(adv_pass_play_type_df)[16] <- "RPO_RushYds"
names(adv_pass_play_type_df)[17] <- "PA_PassAtt"
names(adv_pass_play_type_df)[18] <- "PA_PassYds"
```

Join all of the tables together to create one conclusive advanced passing player analytics table. We'll aslo convert all of the columns that have numbers in them to numeric, and remove NA's.

```{r join_pass_stats}
adv_passing_df <- adv_pass_acc_df %>%
  inner_join(adv_pass_ay_df, by=c("Rk","Player","Tm","Age","Pos", "G", "GS", "Cmp", "Att", "Yds")) %>%
  inner_join(adv_pass_play_type_df, by=c("Rk","Player","Tm","Age","Pos", "G", "GS", "Cmp", "Att", "Yds")) %>%
  inner_join(adv_pass_press_df, by=c("Rk","Player","Tm","Age","Pos", "G", "GS", "Cmp", "Att", "Yds"))

adv_passing_df$GS <- as.numeric(as.character(adv_passing_df$GS))
adv_passing_df$Age <- as.numeric(as.character(adv_passing_df$Age))
adv_passing_df$G <- as.numeric(as.character(adv_passing_df$G))
adv_passing_df$Cmp <- as.numeric(as.character(adv_passing_df$Cmp))
adv_passing_df$Att <- as.numeric(as.character(adv_passing_df$Att))
adv_passing_df$Yds <- as.numeric(as.character(adv_passing_df$Yds))
adv_passing_df$Bats <- as.numeric(as.character(adv_passing_df$Bats))
adv_passing_df$ThAwy <- as.numeric(as.character(adv_passing_df$ThAwy))
adv_passing_df$Spikes <- as.numeric(as.character(adv_passing_df$Spikes))
adv_passing_df$Drops <- as.numeric(as.character(adv_passing_df$Drops))
adv_passing_df$'Drop%' <- as.numeric(sub('%', '', as.character(adv_passing_df$'Drop%')))/100
adv_passing_df$BadTh <- as.numeric(as.character(adv_passing_df$BadTh))
adv_passing_df$'Bad%' <- as.numeric(sub('%', '', as.character(adv_passing_df$'Bad%')))/100
adv_passing_df$OnTgt <- as.numeric(as.character(adv_passing_df$OnTgt))
adv_passing_df$'OnTgt%' <- as.numeric(sub('%', '', as.character(adv_passing_df$'OnTgt%')))/100
adv_passing_df$IAY <- as.numeric(as.character(adv_passing_df$IAY))
adv_passing_df$'IAY/PA' <- as.numeric(as.character(adv_passing_df$'IAY/PA'))
adv_passing_df$CAY <- as.numeric(as.character(adv_passing_df$CAY))
adv_passing_df$'CAY/Cmp' <- as.numeric(as.character(adv_passing_df$'CAY/Cmp'))
adv_passing_df$'CAY/PA' <- as.numeric(as.character(adv_passing_df$'CAY/PA'))
adv_passing_df$YAC <- as.numeric(as.character(adv_passing_df$YAC))
adv_passing_df$'YAC/Cmp' <- as.numeric(as.character(adv_passing_df$'YAC/Cmp'))
adv_passing_df$RPO_Plays <- as.numeric(as.character(adv_passing_df$RPO_Plays))
adv_passing_df$RPO_Yds <- as.numeric(as.character(adv_passing_df$RPO_Yds))
adv_passing_df$RPO_PassAtt <- as.numeric(as.character(adv_passing_df$RPO_PassAtt))
adv_passing_df$RPO_PassYds <- as.numeric(as.character(adv_passing_df$RPO_PassYds))
adv_passing_df$RPO_RushAtt <- as.numeric(as.character(adv_passing_df$RPO_RushAtt))
adv_passing_df$RPO_RushYds <- as.numeric(as.character(adv_passing_df$RPO_RushYds))
adv_passing_df$PA_PassAtt <- as.numeric(as.character(adv_passing_df$PA_PassAtt))
adv_passing_df$PA_PassYds <- as.numeric(as.character(adv_passing_df$PA_PassYds))
adv_passing_df$Sk <- as.numeric(as.character(adv_passing_df$Sk))
adv_passing_df$PktTime <- as.numeric(as.character(adv_passing_df$PktTime))
adv_passing_df$Bltz <- as.numeric(as.character(adv_passing_df$Bltz))
adv_passing_df$Hrry <- as.numeric(as.character(adv_passing_df$Hrry))
adv_passing_df$Hits <- as.numeric(as.character(adv_passing_df$Hits))
adv_passing_df$Scrm <- as.numeric(as.character(adv_passing_df$Scrm))
adv_passing_df$'Yds/Scr' <- as.numeric(as.character(adv_passing_df$'Yds/Scr'))

adv_passing_df[is.na(adv_passing_df)] <- 0

adv_passing_df$Rk <- as.numeric(as.character(adv_passing_df$Rk))
adv_passing_df <- adv_passing_df %>%
  filter(Rk <= 29)

head(adv_passing_df)
```

Standardize the advanced passing stats like we did before with the standard passing data.
```{r standardize_adv}

rm(adv_pass_acc_df, adv_pass_ay_df, adv_pass_play_type_df, adv_pass_press_df)

adv_passing_df <- adv_passing_df %>%
  mutate('Bats/G' = Bats/G) %>%
  mutate('ThAwy/G' = ThAwy/G) %>%
  mutate('RPO_Plays/G' = RPO_Plays/G) %>%
  mutate('RPO_Yds/G' = RPO_Yds/G) %>%
  mutate('RPO_PassAtt/G' = RPO_PassAtt/G) %>%
  mutate('RPO_PassYds/G' = RPO_PassYds/G) %>%
  mutate('RPO_RushAtt/G' = RPO_RushAtt/G) %>%
  mutate('RPO_RushYds/G' = RPO_RushYds/G) %>%
  mutate('PA_PassAtt/G' = PA_PassAtt/G) %>%
  mutate('PA_PassYds/G' = PA_PassYds/G) %>%
  mutate('Bltz/G' = Bltz/G) %>%
  mutate('Hrry/G' = Hrry/G) %>%
  mutate('Hits/G' = Hits/G) %>%
  mutate('Scrm/G' = Scrm/G)

adv_passing_df$Cmp <- NULL
adv_passing_df$Att <- NULL
adv_passing_df$Yds <- NULL
adv_passing_df$Spikes <- NULL
adv_passing_df$IAY <- NULL
adv_passing_df$CAY <- NULL
adv_passing_df$YAC <- NULL
adv_passing_df$Sk <- NULL
adv_passing_df$Bats <- NULL
adv_passing_df$ThAwy <- NULL
adv_passing_df$Drops <- NULL
adv_passing_df$BadTh <- NULL
adv_passing_df$OnTgt <- NULL
adv_passing_df$IAY <- NULL
adv_passing_df$CAY <- NULL
adv_passing_df$YAC <- NULL
adv_passing_df$Drops <- NULL
adv_passing_df$RPO_Plays <- NULL
adv_passing_df$RPO_Yds <- NULL
adv_passing_df$RPO_PassAtt <- NULL
adv_passing_df$RPO_PassYds <- NULL
adv_passing_df$RPO_RushAtt <- NULL
adv_passing_df$RPO_RushYds <- NULL
adv_passing_df$PA_PassAtt <- NULL
adv_passing_df$PA_PassYds <- NULL
adv_passing_df$Bltz <- NULL
adv_passing_df$Hrry <- NULL
adv_passing_df$Hits <- NULL
adv_passing_df$Scrm <- NULL
```

Now we'll join the standardized datasets (of standard and advanced passing data) to get one super passing dataset.
```{r join_std_adv}
pass_df <- std_pass_df %>%
  inner_join(adv_passing_df, by=c("Rk","Player","Tm","Age","Pos", "G", "GS"))

```

Now lets convert the QB records into a useful statstic... win percentage.
```{r win_%}

pass_df$QBrec <- as.numeric(gsub( "-.*$", "", pass_df$QBrec))

pass_df <- pass_df %>%
  mutate('Win%' = QBrec/G)

pass_df$QBrec <- NULL

write.csv(pass_df, "pass_df.csv")

```
Beautiful.